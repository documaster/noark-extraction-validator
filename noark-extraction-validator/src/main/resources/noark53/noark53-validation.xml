<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!--
        Noark Extraction Validator
        Copyright (C) 2016, Documaster AS

        This program is free software: you can redistribute it and/or modify
        it under the terms of the GNU Affero General Public License as
        published by the Free Software Foundation, either version 3 of the
        License, or (at your option) any later version.

        This program is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Affero General Public License for more details.

        You should have received a copy of the GNU Affero General Public License
        along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<validation>
    <target>Noark 5.3</target>

    <!-- View the associated xsd for more information on the structure of the file. -->
    <!-- Note that there is a limitation on the possible values of the group element -->

    <rule>
        <title>arkivstruktur.xml checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'arkivstruktur.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'arkivstruktur.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'arkivstruktur.xml'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'arkivstruktur.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'arkivstruktur.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'arkivstruktur.xml'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>arkivstruktur.xsd checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'arkivstruktur.xsd' file_name, LOWER(detected.value) detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'arkivstruktur.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'arkivstruktur.xsd'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'arkivstruktur.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'arkivstruktur.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'arkivstruktur.xsd'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>loependejournal.xml checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'loependeJournal.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'loependejournal.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'loependeJournal.xml'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'loependeJournal.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'loependejournal.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'loependeJournal.xml'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>loependejournal.xsd checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'loependeJournal.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'loependejournal.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'loependeJournal.xsd'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'loependeJournal.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'loependejournal.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'loependeJournal.xsd'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>offentligJournal.xml checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'offentligJournal.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'offentligjournal.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'offentligJournal.xml'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'offentligJournal.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'offentligjournal.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'offentligJournal.xml'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>offentligJournal.xsd checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'offentligJournal.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'offentligjournal.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'offentligJournal.xsd'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'offentligJournal.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'offentligjournal.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'offentligJournal.xsd'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>endringslogg.xml checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'endringslogg.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'endringslogg.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'endringslogg.xml'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'endringslogg.xml' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'endringslogg.xml'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'endringslogg.xml'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>endringslogg.xsd checksum</title>
        <group>common</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT 'endringslogg.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'endringslogg.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'endringslogg.xsd'
                    ) detected;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT 'endringslogg.xsd' file_name, detected.value detected_checksum,
                        (
                            SELECT LOWER(property.value) value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.property sibling_property ON sibling_property._parent_id = parent_property._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'checksum' AND sibling_property.name = 'name' AND LOWER(sibling_property.value) = 'endringslogg.xsd'
                            LIMIT 1
                        ) arkivuttrekk_checksum
                    FROM
                    (
                        SELECT LOWER(value) value
                        FROM addml.property
                        WHERE name = 'endringslogg.xsd'
                    ) detected
                    WHERE detected.value <> arkivuttrekk_checksum OR arkivuttrekk_checksum IS NULL OR detected.value IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Extraction-wide systemid field uniqueness</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT COUNT(*) total_non_unique_or_null_system_ids FROM (
                        SELECT systemid FROM (
                                SELECT systemid
                                FROM arkivstruktur.arkiv
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.arkivdel
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.klassifikasjonssystem
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.klasse
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.mappe
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.registrering
                            UNION ALL
                                SELECT systemid
                                FROM arkivstruktur.dokumentbeskrivelse
                        )
                        GROUP BY systemid
                        HAVING COUNT(*) > 1 OR systemid IS NULL
                    ) non_unique_or_null_systemids
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT entity, systemid, count(*) total FROM (
                            SELECT 'fonds' entity, systemid
                            FROM arkivstruktur.arkiv
                        UNION ALL
                            SELECT 'series' entity, systemid
                            FROM arkivstruktur.arkivdel
                        UNION ALL
                            SELECT 'klassifikasjonssystem' entity, systemid
                            FROM arkivstruktur.klassifikasjonssystem
                        UNION ALL
                            SELECT 'klasse' entity, systemid
                            FROM arkivstruktur.klasse
                        UNION ALL
                            SELECT 'mappe' entity, systemid
                            FROM arkivstruktur.mappe
                        UNION ALL
                            SELECT 'registrering' entity, systemid
                            FROM arkivstruktur.registrering
                        UNION ALL
                            SELECT 'dokumentbeskrivelse' entity, systemid
                            FROM arkivstruktur.dokumentbeskrivelse
                    )
                    GROUP BY entity, systemid
                    HAVING COUNT(*) > 1 OR systemid IS NULL
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Fonds count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT
                        a.systemid system_id,
                        a.tittel title,
                        (_ref_arkiv IS NULL) is_root,
                        (COUNT(*) - 1) children_count
                    FROM arkivstruktur.arkiv a
                    LEFT JOIN arkivstruktur.arkiv b ON a._id = b._parent_id
                    GROUP BY system_id, title, is_root
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Series count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f.systemid fonds_system_id, COUNT(*) series_count
                    FROM arkivstruktur.arkiv f
                    LEFT JOIN arkivstruktur.arkivdel s ON f._id = s._parent_id
                    GROUP BY f.systemid
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT f.systemid fonds_system_id, COUNT(*) series_count
                    FROM arkivstruktur.arkiv f
                    LEFT JOIN arkivstruktur.arkivdel s ON f._id = s._parent_id
                    GROUP BY f.systemid
                    HAVING COUNT(*) < 1
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Fonds period containment</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT inside_period.val fonds_inside_of_period, outside_period.val fonds_outside_of_period
                    FROM
                    (
                        SELECT COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.arkiv
                        WHERE
                            CAST(opprettetdato AS DATE) < period_start_date OR CAST(avsluttetdato AS DATE) > period_end_date
                            OR opprettetdato IS NULL OR avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                    ) outside_period
                    CROSS JOIN
                    (
                        SELECT COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.arkiv
                        WHERE
                            CAST(opprettetdato AS DATE) >= period_start_date AND CAST(avsluttetdato AS DATE) <= period_end_date
                            AND opprettetdato IS NOT NULL AND avsluttetdato IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                    ) inside_period;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT systemid system_id, CAST(opprettetdato AS DATE) created_date, CAST(avsluttetdato AS DATE) finalized_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM arkivstruktur.arkiv
                    WHERE CAST(opprettetdato AS DATE) < period_start_date OR CAST(avsluttetdato AS DATE) > period_end_date
                        OR opprettetdato IS NULL OR avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Series period containment</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT inside_period.val series_inside_of_period, outside_period.val series_outside_of_period
                    FROM
                    (
                        SELECT COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.arkivdel
                        WHERE CAST(opprettetdato AS DATE) < period_start_date
                            OR CAST(avsluttetdato AS DATE) > period_end_date
                            OR opprettetdato IS NULL OR avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                    ) outside_period
                    CROSS JOIN
                    (
                        SELECT COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.arkivdel
                        WHERE CAST(opprettetdato AS DATE) >= period_start_date AND CAST(avsluttetdato AS DATE) <= period_end_date
                            AND opprettetdato IS NOT NULL AND avsluttetdato IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                    ) inside_period;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT systemid system_id, CAST(opprettetdato AS DATE) created_date, CAST(avsluttetdato AS DATE) finalized_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM arkivstruktur.arkivdel
                    WHERE CAST(opprettetdato AS DATE) < period_start_date OR CAST(avsluttetdato AS DATE) > period_end_date
                        OR opprettetdato IS NULL OR avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Series status</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT not_closed.val not_closed_series, closed.val closed_series
                    FROM
                    (
                        SELECT COUNT(*) val
                        FROM arkivstruktur.arkivdel
                        WHERE arkivdelstatus <> 'Avsluttet periode' OR avsluttetdato IS NULL OR avsluttetav IS NULL
                    ) not_closed
                    CROSS JOIN
                    (
                        SELECT COUNT(*) val
                        FROM arkivstruktur.arkivdel
                        WHERE arkivdelstatus = 'Avsluttet periode' AND avsluttetdato IS NOT NULL AND avsluttetav IS NOT NULL
                    ) closed;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT systemid system_id, arkivdelstatus status, avsluttetdato finalized_date, avsluttetav finalized_by
                    FROM arkivstruktur.arkivdel
                    WHERE arkivdelstatus <> 'Avsluttet periode' OR avsluttetdato IS NULL OR avsluttetav IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Classification Systems count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id, COUNT(*) ks_count
                    FROM arkivstruktur.arkivdel s
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks._parent_id = s._id
                    GROUP BY s.systemid
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Class count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT ks.systemid ks_system_id, parent.systemid parent_system_id, COUNT(*) number_of_classes
                    FROM arkivstruktur.klasse k
                    LEFT JOIN arkivstruktur.klasse parent ON parent.systemid = k._ref_klasse
                    LEFT JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                    GROUP BY ks.systemid, parent.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Classes without subclasses, files, or records</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT ks._ref_arkivdel series_system_id, COUNT(DISTINCT(k.systemid)) classes_without_children
                    FROM arkivstruktur.klasse k
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                    WHERE k.systemid NOT IN (SELECT _ref_klasse FROM arkivstruktur.klasse WHERE _ref_klasse IS NOT NULL GROUP BY _ref_klasse)
                        AND k.systemid NOT IN (SELECT _ref_klasse FROM arkivstruktur.mappe WHERE _ref_klasse IS NOT NULL)
                        AND k.systemid NOT IN (SELECT _ref_klasse FROM arkivstruktur.registrering WHERE _ref_klasse IS NOT NULL GROUP BY _ref_klasse)
                    GROUP BY ks._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>File count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, COALESCE(f._dtype, 'mappe') file_type, count(*) number_of_files
                    FROM arkivstruktur.mappe f
                    GROUP BY f._ref_arkivdel, f._dtype

                    UNION ALL

                    SELECT 'total', 'total', count(*)
                    FROM arkivstruktur.mappe;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT arkivstruktur_file_count.val arkivstruktur_file_count,
                        (
                            SELECT property.value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject data_object ON data_object._id = parent_properties3._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'numberOfOccurrences' AND parent_property.value = 'mappe' AND parent_property2.name = 'info' and data_object.name = 'arkivstruktur'
                            LIMIT 1
                        ) arkiv_uttrekk_file_count
                    FROM
                    (
                        SELECT COUNT(*) val
                        FROM arkivstruktur.mappe
                    ) arkivstruktur_file_count
                    WHERE arkivstruktur_file_count.val <> arkiv_uttrekk_file_count OR arkiv_uttrekk_file_count IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>File period containment</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id, COALESCE(inside_period.val, 0) files_inside_period, COALESCE(outside_period.val, 0) files_outside_period
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.mappe f
                        JOIN arkivstruktur.arkivdel s ON s.systemid = f._ref_arkivdel
                        WHERE
                            ( CAST(f.opprettetdato AS DATE) >= period_start_date OR s.arkivdelstatus = 'Overlappingsperiode' ) AND CAST(f.avsluttetdato AS DATE) <= period_end_date
                            AND f.opprettetdato IS NOT NULL AND f.avsluttetdato IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                        GROUP BY f._ref_arkivdel, period_start_date, period_end_date
                    ) inside_period ON s.systemid = inside_period.series_system_id
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.mappe f
                        JOIN arkivstruktur.arkivdel s ON s.systemid = f._ref_arkivdel
                        WHERE
                            ( CAST(f.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(f.avsluttetdato AS DATE) > period_end_date
                            OR f.opprettetdato IS NULL OR f.avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                        GROUP BY f._ref_arkivdel, period_start_date, period_end_date
                    ) outside_period ON s.systemid = outside_period.series_system_id;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, f.systemid file_system_id, CAST(f.opprettetdato AS DATE) created_date, CAST(f.avsluttetdato AS DATE) finalized_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM arkivstruktur.mappe f
                    JOIN arkivstruktur.arkivdel s ON s.systemid = f._ref_arkivdel
                    WHERE
                        ( CAST(f.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' )
                        OR CAST(f.avsluttetdato AS DATE) > period_end_date
                        OR f.opprettetdato IS NULL OR f.avsluttetdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Files within leaf classes</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT ks._ref_arkivdel series_system_id, kf._ref_klasse class_system_id, kf.val number_of_files, COALESCE(kk.val, 0) number_of_classes
                    FROM
                        (
                        SELECT _ref_klasse, COUNT(*) val
                        FROM arkivstruktur.mappe
                        WHERE _ref_klasse IS NOT NULL
                        GROUP BY _ref_klasse
                        ) kf
                    LEFT JOIN
                        (
                        SELECT k1.systemid, COUNT(*) val
                        FROM arkivstruktur.klasse k1
                        JOIN arkivstruktur.klasse k2 ON k2._ref_klasse = k1.systemid
                        GROUP BY k1.systemid
                        ) kk
                        ON kk.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klasse k ON k.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT ks._ref_arkivdel series_system_id, kf._ref_klasse class_system_id, kf.val number_of_files, kk.val number_of_classes
                    FROM
                        (
                        SELECT _ref_klasse, COUNT(*) val
                        FROM arkivstruktur.mappe
                        WHERE _ref_klasse IN (SELECT _ref_klasse FROM arkivstruktur.klasse WHERE _ref_klasse IS NOT NULL GROUP BY _ref_klasse)
                        GROUP BY _ref_klasse
                        ) kf
                    JOIN
                        (
                        SELECT k1.systemid, COUNT(*) val
                        FROM arkivstruktur.klasse k1
                        JOIN arkivstruktur.klasse k2 ON k2._ref_klasse = k1.systemid
                        GROUP BY k1.systemid
                        ) kk
                        ON kk.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klasse k ON k.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Files within classes</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, f._ref_klasse class_system_id, COUNT(*) number_of_files
                    FROM arkivstruktur.mappe f
                    GROUP BY f._ref_arkivdel, f._ref_klasse;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Files without subfolders or records.</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, COUNT(*) empty_file_count
                    FROM arkivstruktur.mappe f
                    WHERE f.systemid NOT IN (SELECT _ref_mappe FROM arkivstruktur.mappe WHERE _ref_mappe IS NOT NULL GROUP BY _ref_mappe)
                        AND f.systemid NOT IN (SELECT _ref_mappe FROM arkivstruktur.registrering WHERE _ref_mappe IS NOT NULL GROUP BY _ref_mappe)
                    GROUP BY f._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>File status</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, COALESCE(f._dtype, 'mappe') file_type, COALESCE(closed.val, 0) closed_files, COALESCE(not_closed.val, 0) not_closed_files
                    FROM arkivstruktur.mappe f
                    LEFT JOIN (
                        SELECT _ref_arkivdel series_system_id, COALESCE(_dtype, 'mappe') _dtype, COUNT(*) val
                        FROM arkivstruktur.mappe
                        WHERE avsluttetdato IS NULL
                            OR avsluttetav IS NULL
                            OR (_dtype = 'saksmappe' AND saksstatus <> 'Utgr' AND saksstatus <> 'Avsluttet')
                        GROUP BY _ref_arkivdel, _dtype
                    ) not_closed ON not_closed.series_system_id = f._ref_arkivdel AND f._dtype = not_closed._dtype
                    LEFT JOIN (
                        SELECT _ref_arkivdel series_system_id, COALESCE(_dtype, 'mappe') _dtype, COUNT(*) val
                        FROM arkivstruktur.mappe
                        WHERE avsluttetdato IS NOT NULL
                            AND avsluttetav IS NOT NULL
                            OR (_dtype = 'saksmappe' AND saksstatus = 'Utgr' AND saksstatus = 'Avsluttet')
                        GROUP BY _ref_arkivdel, _dtype
                    ) closed ON closed.series_system_id = f._ref_arkivdel AND f._dtype = closed._dtype
                    GROUP BY f._ref_arkivdel, f._dtype, not_closed_files, closed_files;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, COALESCE(f._dtype, 'mappe') file_type, f.systemid file_system_id, f.avsluttetdato finalized_date, f.avsluttetav finalized_by, f.saksstatus file_status
                    FROM arkivstruktur.mappe f
                    WHERE f.avsluttetdato IS NULL
                        OR f.avsluttetav IS NULL
                        OR (f._dtype = 'saksmappe' AND f.saksstatus <> 'Utgr' AND f.saksstatus <> 'Avsluttet');
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Record count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COALESCE(r._dtype, 'registrering') record_type, count(*) number_of_records
                    FROM arkivstruktur.registrering r
                    GROUP BY r._ref_arkivdel, r._dtype

                    UNION ALL

                    SELECT 'total', 'total', COUNT(*)
                    FROM arkivstruktur.registrering;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT arkivstruktur_record_count.val arkivstruktur_record_count,
                        (
                            SELECT property.value val
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject data_object ON data_object._id = parent_properties3._parent_id
                            WHERE property.name = 'value' AND parent_property.name = 'numberOfOccurrences' AND parent_property.value = 'registrering' AND parent_property2.name = 'info' AND data_object.name = 'arkivstruktur'
                            LIMIT 1
                        ) arkivuttrekk_record_count
                    FROM
                    (
                        SELECT COUNT(*) val
                        FROM arkivstruktur.registrering
                    ) arkivstruktur_record_count
                    WHERE arkivstruktur_record_count.val <> arkivuttrekk_record_count OR arkivuttrekk_record_count IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Registry entries without a main document</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, r._dtype registry_entry_type, COUNT(*) registry_entries_without_a_main_document
                    FROM arkivstruktur.registrering r
                    WHERE r._dtype = 'journalpost' AND r.systemid NOT IN (
                        SELECT _ref_registrering
                        FROM arkivstruktur.dokumentbeskrivelse
                        WHERE tilknyttetregistreringsom = 'Hoveddokument' AND _ref_registrering IS NOT NULL
                        GROUP BY _ref_registrering
                    )
                    GROUP BY r._ref_arkivdel, r._dtype;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Record period containment</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_systemid, COALESCE(inside_period.val, 0) records_inside_period, COALESCE(outside_period.val, 0) records_outside_period
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.registrering r
                        JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE
                            ( CAST(r.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(r.arkivertdato AS DATE) > period_end_date
                            OR r.opprettetdato IS NULL OR r.arkivertdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                        GROUP BY r._ref_arkivdel, period_start_date, period_end_date
                    ) outside_period ON s.systemid = outside_period.series_system_id
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM arkivstruktur.registrering r
                        JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE
                            ( CAST(r.opprettetdato AS DATE) >= period_start_date OR s.arkivdelstatus = 'Overlappingsperiode' ) AND CAST(r.arkivertdato AS DATE) <= period_end_date
                            AND r.opprettetdato IS NOT NULL AND r.arkivertdato IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                        GROUP BY r._ref_arkivdel, period_start_date, period_end_date
                    ) inside_period ON s.systemid = outside_period.series_system_id;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, r.systemid record_system_id, CAST(r.opprettetdato AS DATE) created_date, CAST(r.arkivertdato AS DATE) finalized_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM arkivstruktur.registrering r
                    JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                    WHERE
                        ( CAST(r.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(r.arkivertdato AS DATE) > period_end_date
                        OR r.opprettetdato IS NULL OR r.arkivertdato IS NULL OR period_start_date IS NULL OR period_end_date IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Records within leaf classes</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT ks._ref_arkivdel series_system_id, kf._ref_klasse class_system_id, kf.val number_of_records, COALESCE(kk.val, 0) number_of_classes
                    FROM
                        (
                        SELECT _ref_klasse, COUNT(*) val
                        FROM arkivstruktur.registrering
                        WHERE _ref_klasse IS NOT NULL AND _ref_mappe IS NULL
                        GROUP BY _ref_klasse
                        ) kf
                    LEFT JOIN
                        (
                        SELECT k1.systemid, COUNT(*) val
                        FROM arkivstruktur.klasse k1
                        JOIN arkivstruktur.klasse k2 ON k2._ref_klasse = k1.systemid
                        GROUP BY k1.systemid
                        ) kk
                        ON kk.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klasse k ON k.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT ks._ref_arkivdel series_system_id, kf._ref_klasse class_system_id, kf.val number_of_records, kk.val number_of_classes
                    FROM
                        (
                        SELECT _ref_klasse, COUNT(*) val
                        FROM arkivstruktur.registrering
                        WHERE _ref_mappe IS NULL AND _ref_klasse IN (SELECT _ref_klasse FROM arkivstruktur.klasse WHERE _ref_klasse IS NOT NULL GROUP BY _ref_klasse)
                        GROUP BY _ref_klasse
                        ) kf
                    JOIN
                        (
                        SELECT k1.systemid, COUNT(*) val
                        FROM arkivstruktur.klasse k1
                        JOIN arkivstruktur.klasse k2 ON k2._ref_klasse = k1.systemid
                        GROUP BY k1.systemid
                        ) kk
                        ON kk.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klasse k ON k.systemid = kf._ref_klasse
                    JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Records within classes</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, r._ref_klasse class_system_id, COUNT(*) number_of_files
                    FROM arkivstruktur.registrering r
                    WHERE r._ref_mappe IS NULL
                    GROUP BY r._ref_arkivdel, r._ref_klasse;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Records without document descriptions</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) records_without_documents
                    FROM arkivstruktur.registrering r
                    WHERE r.systemid NOT IN (SELECT _ref_registrering FROM arkivstruktur.dokumentbeskrivelse WHERE _ref_registrering IS NOT NULL GROUP BY _ref_registrering)
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Record status</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COALESCE(r._dtype, 'registrering') record_type, COALESCE(closed.val, 0) closed_records, COALESCE(not_closed.val, 0) not_closed_records
                    FROM arkivstruktur.registrering r
                    LEFT JOIN (
                        SELECT _ref_arkivdel series_system_id, COALESCE(_dtype, 'registrering') _dtype, COUNT(*) val
                        FROM arkivstruktur.registrering
                        WHERE arkivertdato IS NULL
                            OR arkivertav IS NULL
                            OR (_dtype = 'journalpost' AND journalstatus <> 'Arkivert' AND journalstatus <> 'Utgr')
                        GROUP BY _ref_arkivdel, _dtype
                    ) not_closed ON not_closed.series_system_id = r._ref_arkivdel AND r._dtype = not_closed._dtype
                    LEFT JOIN (
                        SELECT _ref_arkivdel series_system_id, COALESCE(_dtype, 'registrering') _dtype, COUNT(*) val
                        FROM arkivstruktur.registrering
                        WHERE arkivertdato IS NOT NULL
                            AND arkivertav IS NOT NULL
                            OR (_dtype = 'journalpost' AND journalstatus = 'Arkivert' AND journalstatus = 'Utgr')
                        GROUP BY _ref_arkivdel, _dtype
                    ) closed ON closed.series_system_id = r._ref_arkivdel AND r._dtype = closed._dtype
                    GROUP BY r._ref_arkivdel, r._dtype, not_closed_records, closed_records;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COALESCE(r._dtype, 'registrering') record_type, r.systemid record_system_id, r.arkivertdato finalized_date, r.arkivertav finalized_by, journalstatus record_status
                    FROM arkivstruktur.registrering r
                    WHERE r.arkivertdato IS NULL
                        OR r.arkivertav IS NULL
                        OR (_dtype = 'journalpost' AND journalstatus <> 'Arkivert' AND journalstatus <> 'Utgr');
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Document Description count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, count(*) number_of_document_description
                    FROM arkivstruktur.dokumentbeskrivelse d
                    JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                    GROUP BY r._ref_arkivdel

                    UNION ALL

                    SELECT 'total', count(*)
                    FROM arkivstruktur.dokumentbeskrivelse;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Document Descriptions without Document Objects</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) document_descriptions_without_document_objects
                    FROM arkivstruktur.dokumentbeskrivelse d
                    JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                    WHERE d.systemid NOT IN (
                        SELECT _ref_dokumentbeskrivelse
                        FROM arkivstruktur.dokumentobjekt
                        WHERE _ref_dokumentbeskrivelse IS NOT NULL
                        GROUP BY _ref_dokumentbeskrivelse
                    )
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Document Description status</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COALESCE(closed.val, 0) closed_documents, COALESCE(not_closed.val, 0) not_closed_documents
                    FROM arkivstruktur.registrering r
                    LEFT JOIN (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.dokumentbeskrivelse d
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        WHERE dokumentstatus <> 'Dokumentet er ferdigstilt'
                        GROUP BY r._ref_arkivdel
                    ) not_closed ON not_closed.series_system_id = r._ref_arkivdel
                    LEFT JOIN (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.dokumentbeskrivelse d
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        WHERE dokumentstatus = 'Dokumentet er ferdigstilt'
                        GROUP BY r._ref_arkivdel
                    ) closed ON closed.series_system_id = r._ref_arkivdel
                    GROUP BY r._ref_arkivdel, not_closed_documents, closed_documents;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, d.systemid document_description_system_id, dokumentstatus document_status
                    FROM arkivstruktur.dokumentbeskrivelse d
                    JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                    WHERE dokumentstatus <> 'Dokumentet er ferdigstilt';
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Document Description period containment</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id, COALESCE(inside_period.val, 0) documents_inside_period, COALESCE(outside_period.val, 0) documents_outside_period
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date
                        FROM arkivstruktur.dokumentbeskrivelse d
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE
                            ( CAST(d.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR d.opprettetdato IS NULL OR period_start_date IS NULL
                        GROUP by r._ref_arkivdel, period_start_date
                    ) outside_period ON s.systemid = outside_period.series_system_id
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date
                        FROM arkivstruktur.dokumentbeskrivelse d
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE
                            ( CAST(d.opprettetdato AS DATE) >= period_start_date OR s.arkivdelstatus = 'Overlappingsperiode' ) AND d.opprettetdato IS NOT NULL AND period_start_date IS NOT NULL
                        GROUP by r._ref_arkivdel, period_start_date
                    ) inside_period ON inside_period.series_system_id = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, d.systemid document_description_system_id, CAST(d.opprettetdato AS DATE) created_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date
                    FROM arkivstruktur.dokumentbeskrivelse d
                    JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                    JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                    WHERE ( CAST(d.opprettetdato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR d.opprettetdato IS NULL OR period_start_date IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Document Object count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT
                        r._ref_arkivdel series_system_id,
                        COUNT(*) document_objects,
                        (d._ref_dokumentbeskrivelse IS NOT NULL) in_document_description,
                        (d._ref_dokumentbeskrivelse IS NULL) in_record
                    FROM arkivstruktur.dokumentobjekt d
                    LEFT JOIN arkivstruktur.dokumentbeskrivelse dd ON dd._id = d._parent_id
                    LEFT JOIN arkivstruktur.registrering r ON r._id = d._parent_id
                    GROUP BY series_system_id, in_document_description, in_record

                    UNION ALL

                    SELECT 'total', count(*), TRUE in_document_description, TRUE in_record
                    FROM arkivstruktur.dokumentobjekt;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Document object checksums</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                   SELECT COUNT(*) documents_with_invalid_checksums
                   FROM arkivstruktur.dokumentobjekt
                   WHERE LOWER(sjekksum) <> LOWER(_detected_checksum);
                ]]>
            </info>
            <errors>
                <![CDATA[
                   SELECT referansedokumentfil document, sjekksum archive_checksum, _detected_checksum detected_checksum, 'SHA-256' algorithm
                   FROM arkivstruktur.dokumentobjekt
                   WHERE LOWER(sjekksum) <> LOWER(_detected_checksum);
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Document object file types</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                   SELECT COUNT(*) documents_with_invalid_file_type
                   FROM arkivstruktur.dokumentobjekt
                   WHERE _is_valid_type <> 'true';
                ]]>
            </info>
            <errors>
                <![CDATA[
                   SELECT referansedokumentfil document, formatDetaljer archive_file_type, _detected_type detected_file_type, _is_valid_type is_file_type_valid
                   FROM arkivstruktur.dokumentobjekt
                   WHERE _is_valid_type <> 'true';
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Case Party count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT f._ref_arkivdel series_system_id, COUNT(*) number_of_case_parties
                    FROM arkivstruktur.sakspart cp
                    JOIN arkivstruktur.mappe f ON f.systemid = cp._ref_mappe
                    GROUP BY f._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Note count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(f.val, 0) number_of_file_notes,
                        COALESCE(r.val, 0) number_of_record_notes,
                        COALESCE(d.val, 0) number_of_document_notes
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.merknad n
                        JOIN arkivstruktur.mappe f ON f.systemid = n._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) f ON f.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.merknad n
                        JOIN arkivstruktur.registrering r ON r.systemid = n._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) r ON r.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.merknad n
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = n._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) d ON d.series_system_id = s.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Cross reference count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(k.val, 0) number_of_klass_cross_references,
                        COALESCE(f.val, 0) number_of_file_cross_references,
                        COALESCE(r.val, 0) number_of_record_cross_references
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kryssreferanse cr
                        JOIN arkivstruktur.klasse k ON k.systemid = cr._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) k ON k.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kryssreferanse cr
                        JOIN arkivstruktur.mappe f ON f.systemid =  cr._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) f ON f.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kryssreferanse cr
                        JOIN arkivstruktur.registrering r ON r.systemid = cr._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) r ON r.series_system_id = s.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Precedent count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(f.val, 0) number_of_file_precedents,
                        COALESCE(r.val, 0) number_of_record_precedents
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.presedens p
                        JOIN arkivstruktur.mappe f ON f.systemid = p._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) f ON f.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.presedens p
                        JOIN arkivstruktur.registrering r ON r.systemid = p._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) r ON r.series_system_id = s.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Correspondence Party count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) number_of_correspondence_parties
                    FROM arkivstruktur.registrering r
                    JOIN arkivstruktur.korrespondansepart cp ON r.systemid = cp._ref_registrering
                    WHERE r._dtype='journalpost'
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, r.systemid record_system_id
                    FROM arkivstruktur.registrering r
                    WHERE r._dtype = 'journalpost'
                        AND  r.systemid NOT IN (SELECT _ref_registrering FROM arkivstruktur.korrespondansepart WHERE _ref_registrering IS NOT NULL GROUP BY _ref_registrering);
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Sign Off count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) number_of_sign_offs
                    FROM arkivstruktur.registrering r
                    WHERE r._dtype = 'journalpost' AND r.systemid in (SELECT _ref_registrering FROM arkivstruktur.avskrivning WHERE _ref_registrering IS NOT NULL GROUP BY _ref_registrering)
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Document Flow count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) number_of_document_flows
                    FROM arkivstruktur.registrering r
                    WHERE r._dtype = 'journalpost' AND r.systemid in (SELECT _ref_registrering FROM arkivstruktur.dokumentflyt WHERE _ref_registrering IS NOT NULL GROUP BY _ref_registrering)
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Screening count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_screenings,
                        COALESCE(class.val, 0) number_of_class_screenings,
                        COALESCE(file.val, 0) number_of_file_screenings,
                        COALESCE(item.val, 0) number_of_record_screenings,
                        COALESCE(document.val, 0) number_of_document_descriptions_screenings,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'inneholderSkjermetInformasjon'
                            LIMIT 1
                        ) arkivuttrekk_has_screening
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT sc._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming sc
                        GROUP BY sc._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.klasse k ON k.systemid = s._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) class ON class.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.mappe f ON f.systemid = s._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) file ON file.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.registrering r ON r.systemid = s._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) item ON item.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = s._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_screenings,
                        COALESCE(class.val, 0) number_of_class_screenings,
                        COALESCE(file.val, 0) number_of_file_screenings,
                        COALESCE(item.val, 0) number_of_record_screenings,
                        COALESCE(document.val, 0) number_of_document_descriptions_screenings,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'inneholderSkjermetInformasjon'
                            LIMIT 1
                        ) arkivuttrekk_has_screening
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT sc._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming sc
                        GROUP BY sc._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.klasse k ON k.systemid = s._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) class ON class.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.mappe f ON f.systemid = s._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) file ON file.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.registrering r ON r.systemid = s._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) item ON item.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.skjerming s
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = s._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid
                    WHERE
                        (arkivuttrekk_has_screening = 'false' AND (series.val <> 0 OR class.val <> 0 OR file.val <> 0 OR item.val <> 0 OR document.val <> 0))
                        OR
                        (arkivuttrekk_has_screening = 'true' AND (series.val = 0 AND class.val = 0 AND file.val = 0 AND item.val = 0 AND document.val = 0))
                        OR arkivuttrekk_has_screening IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Grading count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_gradings,
                        COALESCE(class.val, 0) number_of_class_gradings,
                        COALESCE(file.val, 0) number_of_file_gradings,
                        COALESCE(item.val, 0) number_of_record_gradings,
                        COALESCE(document.val, 0) number_of_document_descriptions_gradings
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT g._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.gradering g
                        GROUP BY g._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.gradering g
                        JOIN arkivstruktur.klasse k ON k.systemid = g._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) class ON class.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.gradering g
                        JOIN arkivstruktur.mappe f ON f.systemid = g._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) file ON file.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.gradering g
                        JOIN arkivstruktur.registrering r ON r.systemid = g._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) item ON item.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.gradering g
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = g._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Disposal decision count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_disposal_decisions,
                        COALESCE(class.val, 0) number_of_class_disposal_decisions,
                        COALESCE(file.val, 0) number_of_file_disposal_decisions,
                        COALESCE(item.val, 0) number_of_record_disposal_decisions,
                        COALESCE(document.val, 0) number_of_document_descriptions_disposal_decisions,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'inneholderDokumenterSomSkalKasseres'
                            LIMIT 1
                        ) arkivuttrekk_has_disposal_decisions
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT kj._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        GROUP BY kj._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.klasse k ON k.systemid = kj._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) class ON class.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.mappe f ON f.systemid = kj._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) file ON file.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.registrering r ON r.systemid = kj._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) item ON item.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = kj._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_disposal_decisions,
                        COALESCE(class.val, 0) number_of_class_disposal_decisions,
                        COALESCE(file.val, 0) number_of_file_disposal_decisions,
                        COALESCE(item.val, 0) number_of_record_disposal_decisions,
                        COALESCE(document.val, 0) number_of_document_descriptions_disposal_decisions,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'inneholderDokumenterSomSkalKasseres'
                            LIMIT 1
                        ) arkivuttrekk_has_disposal_decisions
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT kj._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        GROUP BY kj._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT ks._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.klasse k ON k.systemid = kj._ref_klasse
                        JOIN arkivstruktur.klassifikasjonssystem ks ON ks.systemid = k._ref_klassifikasjonssystem
                        GROUP BY ks._ref_arkivdel
                    ) class ON class.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT f._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.mappe f ON f.systemid = kj._ref_mappe
                        GROUP BY f._ref_arkivdel
                    ) file ON file.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.registrering r ON r.systemid = kj._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) item ON item.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.kassasjon kj
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = kj._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid
                    WHERE
                        (arkivuttrekk_has_disposal_decisions = 'false' AND (series.val <> 0 OR class.val <> 0 OR file.val <> 0 OR item.val <> 0 OR document.val <> 0))
                        OR
                        (arkivuttrekk_has_disposal_decisions = 'true' AND (series.val = 0 AND class.val = 0 AND file.val = 0 AND item.val = 0 AND document.val = 0))
                        OR arkivuttrekk_has_disposal_decisions IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Disposal count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_disposals,
                        COALESCE(document.val, 0) number_of_document_descriptions_disposals,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'omfatterDokumenterSomErKassert'
                            LIMIT 1
                        ) arkivuttrekk_has_disposals
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT kj._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.utfoertkassasjon kj
                        GROUP BY kj._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.utfoertkassasjon kj
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = kj._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_disposals,
                        COALESCE(document.val, 0) number_of_document_descriptions_disposals,
                        (
                            SELECT value
                            FROM addml.property
                            WHERE name = 'omfatterDokumenterSomErKassert'
                            LIMIT 1
                        ) arkivuttrekk_has_disposals
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT kj._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.utfoertkassasjon kj
                        GROUP BY kj._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.utfoertkassasjon kj
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = kj._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid
                    WHERE
                        (arkivuttrekk_has_disposals = 'false' AND (series.val <> 0 OR document.val <> 0))
                        OR
                        (arkivuttrekk_has_disposals = 'true' AND (series.val = 0 AND document.val = 0))
                        OR arkivuttrekk_has_disposals IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Conversion count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT r._ref_arkivdel series_system_id, COUNT(*) number_of_conversions
                    FROM arkivstruktur.konvertering k
                    JOIN arkivstruktur.dokumentobjekt d ON k._parent_id = d._id
                    JOIN arkivstruktur.dokumentbeskrivelse dd ON dd.systemid = d._ref_dokumentbeskrivelse
                    JOIN arkivstruktur.registrering r ON r.systemid = dd._ref_registrering
                    GROUP BY r._ref_arkivdel;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Deletion apart from disposal count</title>
        <group>arkivstruktur</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id,
                        COALESCE(series.val, 0) number_of_series_deletions_apart_from_disposals,
                        COALESCE(document.val, 0) number_of_document_descriptions_deletions_apart_from_disposals
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT sl._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.sletting sl
                        GROUP BY sl._ref_arkivdel
                    ) series ON series.series_system_id = s.systemid
                    LEFT JOIN
                    (
                        SELECT r._ref_arkivdel series_system_id, COUNT(*) val
                        FROM arkivstruktur.sletting sl
                        JOIN arkivstruktur.dokumentbeskrivelse d ON d.systemid = sl._ref_dokumentbeskrivelse
                        JOIN arkivstruktur.registrering r ON r.systemid = d._ref_registrering
                        GROUP BY r._ref_arkivdel
                    ) document ON document.series_system_id = s.systemid;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Registry Entry count</title>
        <group>loependejournal</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT running.value running_journal, struktur.value arkivstruktur_count,
                        (
                            SELECT property.value value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject parent_data_object ON parent_properties3._parent_id = parent_data_object._id
                            WHERE property.name = 'value'
                                AND parent_property.name = 'numberOfOccurrences'
                                AND parent_property.value = 'journalregistrering'
                                AND parent_data_object.name = 'loependeJournal'
                            LIMIT 1
                        ) arkivuttrekk_count
                    FROM
                    (
                        SELECT count(*) value
                        FROM loependejournal.journalpost
                    ) running
                    CROSS JOIN
                    (
                        SELECT COUNT(*) value
                        FROM arkivstruktur.registrering
                        WHERE _dtype = 'journalpost'
                    ) struktur;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT running.value running_journal, struktur.value arkivstruktur_count,
                        (
                            SELECT property.value value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject parent_data_object ON parent_properties3._parent_id = parent_data_object._id
                            WHERE property.name = 'value'
                                AND parent_property.name = 'numberOfOccurrences'
                                AND parent_property.value = 'journalregistrering'
                                AND parent_data_object.name = 'loependeJournal'
                            LIMIT 1
                        ) arkivuttrekk_count
                    FROM
                    (
                        SELECT count(*) value
                        FROM loependejournal.journalpost
                    ) running
                    CROSS JOIN
                    (
                        SELECT COUNT(*) value
                        FROM arkivstruktur.registrering
                        WHERE _dtype = 'journalpost'
                    ) struktur
                    WHERE running.value <> arkivuttrekk_count OR arkivuttrekk_count IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Period containment of registry entries</title>
        <group>loependejournal</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id, COALESCE(inside_period.val, 0) registry_entries_inside_period, COALESCE(outside_period.val, 0) registry_entries_outside_period
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT s.systemid series_systemid, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM loependejournal.journalpost j
                        LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                        LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE ( CAST(journaldato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(journaldato AS DATE) > period_end_date
                            OR s.systemid IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                        GROUP BY s.systemid, period_start_date, period_end_date
                    ) outside_period ON outside_period.series_systemid = s.systemid
                    LEFT JOIN
                    (
                        SELECT s.systemid series_systemid, COUNT(*) val,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (
                            SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                        FROM loependejournal.journalpost j
                        LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                        LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE ( CAST(journaldato AS DATE) >= period_start_date OR s.arkivdelstatus = 'Overlappingsperiode' ) AND CAST(journaldato AS DATE) <= period_end_date
                            AND s.systemid IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                        GROUP BY s.systemid, period_start_date, period_end_date
                    ) inside_period ON inside_period.series_systemid = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT s.systemid series_system_id, j.systemid registry_entry_system_id, CAST(journaldato AS DATE) registry_entry_date,
                        (SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM loependejournal.journalpost j
                    LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                    LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                    WHERE ( CAST(journaldato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(journaldato AS DATE) > period_end_date
                        OR period_start_date IS NULL OR period_end_date IS NULL OR s.systemid IS NULL
                    ORDER BY journaldato;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Number of screened registry entries</title>
        <group>loependejournal</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT COUNT(tilgangsrestriksjon) screened_registry_entries
                    FROM loependejournal.journalpost;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Registry Entry count</title>
        <group>offentligjournal</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT running.value running_journal, struktur.value arkivstruktur_count,
                        (
                            SELECT property.value value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject parent_data_object ON parent_properties3._parent_id = parent_data_object._id
                            WHERE property.name = 'value'
                                AND parent_property.name = 'numberOfOccurrences'
                                AND parent_property.value = 'journalregistrering'
                                AND parent_data_object.name = 'offentligJournal'
                            LIMIT 1
                        ) arkivuttrekk_count
                    FROM
                    (
                        SELECT count(*) value
                        FROM offentligjournal.journalpost
                    ) running
                    CROSS JOIN
                    (
                        SELECT COUNT(*) value
                        FROM arkivstruktur.registrering
                        WHERE _dtype = 'journalpost'
                    ) struktur;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT running.value running_journal, struktur.value arkivstruktur_count,
                        (
                            SELECT property.value value
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.property parent_property ON parent_properties._parent_id = parent_property._id
                            JOIN addml.properties parent_properties2 ON parent_property._parent_id = parent_properties2._id
                            JOIN addml.property parent_property2 ON parent_properties2._parent_id = parent_property2._id
                            JOIN addml.properties parent_properties3 ON parent_property2._parent_id = parent_properties3._id
                            JOIN addml.dataobject parent_data_object ON parent_properties3._parent_id = parent_data_object._id
                            WHERE property.name = 'value'
                                AND parent_property.name = 'numberOfOccurrences'
                                AND parent_property.value = 'journalregistrering'
                                AND parent_data_object.name = 'offentligJournal'
                            LIMIT 1
                        ) arkivuttrekk_count
                    FROM
                    (
                        SELECT count(*) value
                        FROM offentligJournal.journalpost
                    ) running
                    CROSS JOIN
                    (
                        SELECT COUNT(*) value
                        FROM arkivstruktur.registrering
                        WHERE _dtype = 'journalpost'
                    ) struktur
                    WHERE running.value <> arkivuttrekk_count OR arkivuttrekk_count IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Period containment of registry entries</title>
        <group>offentligjournal</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT s.systemid series_system_id, COALESCE(inside_period.val, 0) registry_entries_inside_period, COALESCE(outside_period.val, 0) registry_entries_outside_period
                    FROM arkivstruktur.arkivdel s
                    LEFT JOIN
                    (
                        SELECT s.systemid series_systemid, COUNT(*) val,
                            (
                                SELECT CAST(property.value AS DATE)
                                FROM addml.property property
                                JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                                JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                                WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                                LIMIT 1
                            ) period_start_date,
                            (
                                SELECT CAST(property.value AS DATE)
                                FROM addml.property property
                                JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                                JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                                WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                                LIMIT 1
                            ) period_end_date
                        FROM offentligjournal.journalpost j
                        LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                        LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE ( CAST(journaldato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(journaldato AS DATE) > period_end_date
                            OR s.systemid IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                        GROUP BY s.systemid, period_start_date, period_end_date
                    ) outside_period ON outside_period.series_systemid = s.systemid
                    LEFT JOIN
                    (
                        SELECT s.systemid series_systemid, COUNT(*) val,
                            (
                                SELECT CAST(property.value AS DATE)
                                FROM addml.property property
                                JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                                JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                                WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                                LIMIT 1
                            ) period_start_date,
                            (
                                SELECT CAST(property.value AS DATE)
                                FROM addml.property property
                                JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                                JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                                WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                                LIMIT 1
                            ) period_end_date
                        FROM offentligjournal.journalpost j
                        LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                        LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                        WHERE ( CAST(journaldato AS DATE) >= period_start_date OR s.arkivdelstatus = 'Overlappingsperiode' ) AND CAST(journaldato AS DATE) <= period_end_date
                            AND s.systemid IS NOT NULL AND period_start_date IS NOT NULL AND period_end_date IS NOT NULL
                        GROUP BY s.systemid, period_start_date, period_end_date
                    ) inside_period ON inside_period.series_systemid = s.systemid;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT s.systemid series_system_id, j.systemid registry_entry_system_id, CAST(journaldato AS DATE) registry_entry_date,
                        (SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'startDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_start_date,
                        (SELECT CAST(property.value AS DATE)
                            FROM addml.property property
                            JOIN addml.properties parent_properties ON property._parent_id = parent_properties._id
                            JOIN addml.additionalelement parent_element ON parent_properties._parent_id = parent_element._id
                            WHERE property.name = 'endDate' AND parent_element.name = 'archivalPeriod'
                            LIMIT 1
                        ) period_end_date
                    FROM offentligjournal.journalpost j
                    LEFT JOIN arkivstruktur.registrering r ON r.systemid = j.systemid
                    LEFT JOIN arkivstruktur.arkivdel s ON s.systemid = r._ref_arkivdel
                    WHERE ( CAST(journaldato AS DATE) < period_start_date AND s.arkivdelstatus <> 'Overlappingsperiode' ) OR CAST(journaldato AS DATE) > period_end_date
                        OR s.systemid IS NULL OR period_start_date IS NULL OR period_end_date IS NULL
                    ORDER BY journaldato;
                ]]>
            </errors>
        </queries>
    </rule>

    <rule>
        <title>Number of changes in endringslogg</title>
        <group>endringslogg</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT COUNT(*) change_count
                    FROM endringslogg.endring;
                ]]>
            </info>
        </queries>
    </rule>

    <rule>
        <title>Check the references in endringslogg</title>
        <group>endringslogg</group>
        <queries>
            <info>
                <![CDATA[
                    SELECT COUNT(*) systemids_not_in_arkivstruktur
                    FROM endringslogg.endring e
                    LEFT JOIN (
                    SELECT systemid
                                        FROM
                                            (SELECT systemid FROM arkivstruktur.arkiv)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.arkiv WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.arkivdel)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.arkivdel WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.klassifikasjonssystem)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.klassifikasjonssystem WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid systemid FROM arkivstruktur.klasse)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.klasse WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid systemid FROM arkivstruktur.mappe)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.mappe WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid systemid FROM arkivstruktur.registrering)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.registrering WHERE systemid IS NULL)
                                        UNION ALL
                                            (SELECT systemid systemid FROM arkivstruktur.dokumentbeskrivelse)
                                        UNION ALL
                                            (SELECT systemid FROM arkivstruktur.dokumentbeskrivelse WHERE systemid IS NULL)
                    UNION ALL
                    (SELECT arkivskaperid FROM arkivstruktur.arkivskaper)
                    UNION ALL
                    (SELECT arkivskaperid FROM arkivstruktur.arkivskaper WHERE arkivskaperid IS NULL)

                    ) all_system_ids ON all_system_ids.systemid = e.referansearkivenhet
                    WHERE all_system_ids.systemid IS NULL;
                ]]>
            </info>
            <errors>
                <![CDATA[
                    SELECT e.referansearkivenhet systemids_not_found_in_arkivstruktur
                    FROM endringslogg.endring e
                    LEFT JOIN (
                        SELECT systemid
                            FROM
                                (SELECT systemid FROM arkivstruktur.arkiv)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.arkiv WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.arkivdel)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.arkivdel WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.klassifikasjonssystem)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.klassifikasjonssystem WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.klasse)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.klasse WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.mappe)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.mappe WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.registrering)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.registrering WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.dokumentbeskrivelse)
                            UNION ALL
                                (SELECT systemid FROM arkivstruktur.dokumentbeskrivelse WHERE systemid IS NULL)
                            UNION ALL
                                (SELECT arkivskaperid FROM arkivstruktur.arkivskaper)
                            UNION ALL
                                (SELECT arkivskaperid FROM arkivstruktur.arkivskaper WHERE arkivskaperid IS NULL)
                    ) all_system_ids ON all_system_ids.systemid = e.referansearkivenhet
                    WHERE all_system_ids.systemid IS NULL;
                ]]>
            </errors>
        </queries>
    </rule>

</validation>
